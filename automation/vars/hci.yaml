---
vas:
  hci:
    stages:
      - path: examples/va/hci/control-plane/nncp
        wait_conditions:
          - >-
            oc -n openstack wait nncp
            -l osp/nncm-config-type=standard
            --for jsonpath='{.status.conditions[0].reason}'=SuccessfullyConfigured
            --timeout=5m
        values:
          - name: network-values
            src_file: values.yaml
        build_output: nncp.yaml

      - path: examples/va/hci/control-plane
        wait_conditions:
          - >-
            oc -n openstack wait osctlplane controlplane --for condition=Ready
            --timeout=60m
        values:
          - name: service-values
            src_file: service-values.yaml
          - name: network-values
            src_file: nncp/values.yaml
        build_output: ../control-plane.yaml

      - path: examples/va/hci/edpm-pre-ceph/nodeset
        wait_conditions:
          - >-
            oc -n openstack wait
            osdpns openstack-edpm --for condition=SetupReady
            --timeout=10m
        values:
          - name: edpm-nodeset-values
            src_file: values.yaml
        build_output: nodeset-pre-ceph.yaml

      - path: examples/va/hci/edpm-pre-ceph/deployment
        wait_conditions:
          - >-
            oc -n openstack wait
            osdpns openstack-edpm --for condition=Ready
            --timeout=30m
        values:
          - name: edpm-deployment-values
            src_file: values.yaml
        build_output: deployment-pre-ceph.yaml
        post_stage_run:
          - name: Deploy Ceph
            type: playbook
            source: "../../playbooks/ceph.yml"
            inventory: "${HOME}/ci-framework-data/artifacts/zuul_inventory.yml"

      - path: examples/va/hci
        wait_conditions:
          - >-
            oc -n openstack wait
            osdpns openstack-edpm --for condition=SetupReady
            --timeout=10m
        values:
          - name: service-values
            src_file: service-values.yaml
          - name: edpm-nodeset-values-post-ceph
            src_file: values.yaml
        build_output: nodeset-post-ceph.yaml

      - path: examples/va/hci/deployment
        wait_conditions:
          - >-
            oc -n openstack wait
            osdpns openstack-edpm --for condition=Ready
            --timeout=40m
        values:
          - name: edpm-deployment-values-post-ceph
            src_file: values.yaml
        build_output: deployment-post-ceph.yaml

# Adoption related content for adoption
adoption:
  hci:
    layout_patch:
      vms:
        # Let's remove the default computes, since we want to adopt the
        # OSP ones
        compute:
          amount: 0
        osp-undercloud:
          amount: 1
          disk_file_name: rhel-8.10.qcow2
          image_local_dir: "{{ cifmw_basedir }}/images/"
          image_url: "{{ cifmw_discovered_image_url }}"
          sha256_image_name: "{{ cifmw_discovered_hash }}"
          memory: 16
          cpus: 8
          disksize: 80
          nets:
            - ocpbm
            - osp_trunk
        osp-controller:
          amount: 3
          disk_file_name: rhel-8.10.qcow2
          image_local_dir: "{{ cifmw_basedir }}/images/"
          image_url: "{{ cifmw_discovered_image_url }}"
          sha256_image_name: "{{ cifmw_discovered_hash }}"
          memory: 16
          cpus: 8
          disksize: 80
          nets:
            - ocpbm
            - osp_trunk
        osp-compute:
          amount: 3
          disk_file_name: rhel-8.10.qcow2
          image_local_dir: "{{ cifmw_basedir }}/images/"
          image_url: "{{ cifmw_discovered_image_url }}"
          sha256_image_name: "{{ cifmw_discovered_hash }}"
          memory: 4
          cpus: 4
          disksize: 20
          nets:
            - ocpbm
            - osp_trunk
    networking_mapper_patch:
      group-templates:
        osp-controllers:
          network-template:
            range:
              start: 200
              length: 3
          networks: &osp_nets
            ctlplane: {}
            internalapi:
              trunk-parent: ctlplane
            tenant:
              trunk-parent: ctlplane
            storage:
              trunk-parent: ctlplane
            storagemgmt:
              trunk-parent: ctlplane
        osp-computes:
          network-template:
            range:
              start: 210
              length: 3
          networks: *osp_nets
        osp-underclouds:
          network-template:
            range:
              start: 199
              length: 1
          networks: *osp_nets
    undercloud:
      config:
        - section: DEFAULT
          option: undercloud_hostname
          value: undercloud.localdomain
        # other undercloud values
    pre_oc_run:
      - name: Deploy Ceph
        type: playbook
        source: "path_to_playbook tbd"
        inventory: "path_to_invenotry_tbd"
    cloud_domain: "localdomain"
    hostname_groups_map:
      # map ansible groups in the inventory to role hostname format for
      # 17.1 deployment
      osp-computes: "overcloud-computehci"
      osp-controllers: "overcloud-controller"
    overcloud:
      stackname: "overcloud"
      args:
        - "--override-ansible-cfg /home/zuul/ansible_config.cfg"
        - "--templates /usr/share/openstack-tripleo-heat-templates"
        - "--libvirt-type qemu"
        - "--timeout 90"
        - "--overcloud-ssh-user zuul"
        - "--deployed-server"
        - "--validation-warnings-fatal"
        - "--disable-validations"
        - "--heat-type pod"
        - "--disable-protected-resource-types"
      vars:
        - "/home/zuul/deployed_ceph.yaml"
        - "/usr/share/openstack-tripleo-heat-templates/environments/docker-ha.yaml"
        - "/usr/share/openstack-tripleo-heat-templates/environments/podman.yaml"
        - "/usr/share/openstack-tripleo-heat-templates/environments/low-memory-usage.yaml"
        - "/usr/share/openstack-tripleo-heat-templates/environments/debug.yaml"
        - "/usr/share/openstack-tripleo-heat-templates/environments/manila-cephfsnative-config.yaml"
        - "/usr/share/openstack-tripleo-heat-templates/environments/enable-legacy-telemetry.yaml"
        - "/usr/share/openstack-tripleo-heat-templates/environments/cephadm/cephadm.yaml"
        - "/usr/share/openstack-tripleo-heat-templates/environments/cephadm/ceph-mds.yaml"
      services_file: "adoption/hci/overcloud_services.yaml"
      network_data_file: "adoption/hci/network_data.yaml"
      vips_data_file: "adoption/hci/vips_data.yaml"
      roles_file: "adoption/hci/roles.yaml"
      ceph_osd_spec_file: "adoption/hci/osd_spec.yaml"
      config_download_file: "adoption/hci/config-download.yaml"
